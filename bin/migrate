#!/usr/bin/env python3

""" migrate

Usage:
  migrate <target> status [--folder=<folder>] [--verbose]
  migrate add <step> <type> [--folder=<folder>] [--verbose]
  migrate <target> up-to (<step> | --latest) [--folder=<folder>] [--verbose]
  migrate <target> rollback-to (<step> | --first) [--folder=<folder>] [--verbose]
  migrate (-h | --help)
  migrate --version

Arguments:

  <step>                 The step name
  <type>                 The file extension
  <target>               Where to execute the migrations

Options:
  -h --help              Show this screen.
  --version              Show version.
  --verbose              Let exceptions raise.
  --folder=<folder>      Where to read and store files

"""

from docopt import docopt
import os
import sys
import migrate

if __name__ == '__main__':
    spec = docopt(__doc__, version='0.1.0')

    root = spec['--folder'] or '%s/migrations' % os.getcwd()

    if spec['--verbose']:
        print('Using root folder: %s' % (root), file=sys.stderr)

    try:
        if spec['status']:
            migrate.status(root, spec['<target>'])

        elif spec['add']:
            migrate.add(root, spec['<step>'], spec['<type>'])

        elif spec['up-to']:
            if spec['--latest']:
                migrate.up_to_latest(root, spec['<target>'], spec['--verbose'])
            else:
                migrate.up_to(root, spec['<target>'], spec['<step>'], spec['--verbose'])

        elif spec['rollback-to']:
            if spec['--first']:
                migrate.rollback_to_first(root, spec['<target>'], spec['--verbose'])
            else:
                migrate.rollback_to(root, spec['<target>'], spec['<step>'], spec['--verbose'])
    except Exception as e:
        if spec['--verbose']:
            raise e

        print(str(e), file=sys.stderr)
        sys.exit(1)

